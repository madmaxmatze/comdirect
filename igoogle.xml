<?xml version="1.0" encoding="utf-8"?> 

<Module>
	<ModulePrefs
		title           ="Comdirect Depot"
		title_url       ="http://mathiasnitzsche.de/comdirect"
		directory_title ="Comdirect Depot"
		screenshot		=""
		thumbnail		=""
		description		="Binden Sie ihr Comdirect Musterdepot auf iGoogle ein"
		author			="MadMaxMatze"
		author_email	="madmaxmatze@gmail.com"
		author_link		="http://mathiasnitzsche.de"
		author_location	="Berlin, Germany"
		author_photo    ="http://mysearches.googlecode.com/svn/trunk/img/author_photo.png"
		singleton       ="false"
		height         	="20"
		>
		<Require feature="setprefs" /> 
		<Require feature="dynamic-height" />
		<Require feature="analytics" />
	</ModulePrefs>
	<UserPref name="gourl0" default_value="" display_name="Depot URL1" />
	<UserPref name="gourl1" default_value="" display_name="Depot URL2" />
	<UserPref name="gourl2" default_value="" display_name="Depot URL3" />
	<UserPref name="gourl3" default_value="" display_name="Depot URL4" />
	<UserPref name="gourl4" default_value="" display_name="Depot URL5" />
	<UserPref name="gourl5" default_value="" display_name="Depot URL6" />
	<UserPref name="gourl6" default_value="" display_name="Depot URL7" />
	
	
	<Content type="html"><![CDATA[
		<!--
			<div style="text-align: center; font-size: 9pt; border: 1px dotted #CCC; padding: 2px; margin: 2px;">
				Comdirect hat eine groessere Aenderung vollzogen, weswegen dieses Modul demnaechst falsche oder keine Daten mehr anzeigt. 
				Um dies zu verhindern, muessen in den Einstellungen des Modules alle Depots-Url durch neue Comdirect-"Freund zeigen" Urls ersetzt werden.
			</div>
		-->
		
		<div id="mmmdepotdiv"></div>
		
		<script>
			function saveToAnalytics(_id) {
				if (typeof _IG_Analytics != 'undefined') {
					if (!_id || _id.indexOf("http") != -1) {
						_IG_Analytics('UA-648146-5', '/comdirect' + (_id ? "/" + _id : ""));
					}
				}
			}	

			saveToAnalytics ();
			// var googlePrefs = new _IG_Prefs("__MODULE_ID__");
			var goUrls = new Array("header", "__UP_gourl0__", "__UP_gourl1__", "__UP_gourl2__", "__UP_gourl3__", "__UP_gourl4__", "__UP_gourl5__", "__UP_gourl6__");
			
			function updateGoUrls(id, portfolio_key) {
				saveToAnalytics (portfolio_key);
				
				_IG_FetchContent("http://apps.mathiasnitzsche.de/comdirect/depot.php?portfolio_key=" + portfolio_key + "&source=modul", 
					_IG_Callback(handleResponse, id, portfolio_key), 
					{refreshInterval: (60 * 10)}
				);
			}
			
			function handleResponse (responseText, id, portfolio_key) {
				if (responseText.length > 100) {
					if (_gel("mmmdepotdiv" + id)) _gel("mmmdepotdiv" + id).innerHTML = responseText;
					_IG_AdjustIFrameHeight();			
					window.setTimeout(function () {updateGoUrls(id, portfolio_key);}, (3 * 60 * 1000));
				}
			}

			var prefs = new _IG_Prefs(__MODULE_ID__);
			for (i = 0; i < goUrls.length; i++) {
				if (goUrls[i] != "") {
					if (goUrls[i] == "header") {
						goUrls[i] = "header" + goUrls.join(",").replace(/[^\d\,]*/ig, "").replace("\,+", ",");
					} else {
						var newGoUrl = goUrls[i].replace(/\D*/ig, "");
						if (newGoUrl != goUrls[i]) {
							goUrls[i] = newGoUrl;
							prefs.set("gourl" + (i - 1), newGoUrl);
						}
					}
					
					if (!_gel("mmmdepotdiv" + i)) {
						_gel("mmmdepotdiv").innerHTML += "<div id='mmmdepotdiv" + i + "' class='mmmdepotdiv'>" + (goUrls[i].indexOf("header") == -1 ? "Lade <a href='" + goUrls[i] + "' target='_blank'>Depot</a>" : "") + "<div>";
						_IG_AdjustIFrameHeight();	
					}
					
					updateGoUrls(i, goUrls[i]);
				}
			}
			
			if (goUrls.length == 0) {
				_gel("mmmdepotdiv").innerHTML = "Gehe zu deinem Comdirect.de Account > Musterdepot > Freund zeigen > portfolio_key aus dem Link hier im Modul-Setup einfuegen";
			}
		</script>
		
	]]></Content>
</Module>